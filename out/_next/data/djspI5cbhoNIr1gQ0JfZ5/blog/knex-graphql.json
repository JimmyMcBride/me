{"pageProps":{"htmlString":"\n## How To Create A Knex / Graphql Back End ðŸ–¥\n\n![Banner](https://i.imgur.com/yiDtHBp.png)\n\n### Step 1\n\nCreate a project directory. `mkdir knex-graphql`.\n\nThen run `yarn init`. When it asks your for the main file, add `src/index.js`.\n\nNow that have that ready we can star adding the dependencies we're going to need.\n\n> Graphql has a rich ecosystem with many amazing options. Feel free to experiment with the plethora of amazing graphql tools out there!\n\n`yarn add -D nodemon dotenv`\n\n`yarn add express apollo-server-express graphql knex pg`\n\nThere's a few things we don't want to push up to our GitHub repo. `touch .gitignore` in the root of your repo and add:\n\n```bash\nnode_modules/\n.env\nyarn-error.log\n```\n\nNow that we have all our tools added, let's set up out database!\n\n### Step 2\n\nLet's create a sql file and set up some scripts in our package.json.\n\n`touch remakeDatabase.sql`\n\n```sql\nDROP DATABASE IF EXISTS my_db;\n\nCREATE DATABASE my_db;\n```\n\nOpen package.json and these scripts:\n\n```json\n{\n  \"scripts\": {\n    \"start\": \"node src/index.js\",\n    \"server\": \"nodemon src/index.js\",\n    \"db-remake\": \"psql -f remakeDatabase.sql\"\n  }\n}\n```\n\nNow we can use the command `yarn db-remake` anytime we want to rollback our database.\n\n### Step 3\n\nIt's time to get knex set up! In root directory, run: `knex init`. We don't need everything in here, so we're just going to delete staging and testing environments and set knex up to work with postgres.\n\n```javascript\n// knexfile.js\nrequire(\"dotenv\").config();\n\nmodule.exports = {\n  development: {\n    client: \"pg\",\n    connection: process.env.DATABASE_URL,\n    migrations: {\n      directory: \"./src/data/migrations\",\n    },\n    seeds: {\n      directory: \"./src/data/seeds\",\n    },\n  },\n};\n```\n\nWe set our migration and build folders, let's make our data folder with the command `mkdir src/data`. Now that we have that in place, let's set up our migrations and seeds. ðŸŒ±\n\nRun: `knex migrate:make users_table && knex seed:make 01_users`.\n\n```javascript\n// migration file\nexports.up = function (knex) {\n  return knex.schema.createTable(\"users\", (tbl) => {\n    tbl.increments();\n    tbl.text(\"username\").notNullable();\n    tbl.text(\"email\").notNullable();\n    tbl.boolean(\"admin\").default(false);\n  });\n};\n\nexports.down = function (knex) {\n  return knex.schema.dropTableIfExists(\"users\");\n};\n```\n\n```javascript\n// seed file\nexports.seed = function (knex) {\n  // Deletes ALL existing entries\n  return knex(\"users\")\n    .del()\n    .then(function () {\n      // Inserts seed entries\n      return knex(\"users\").insert([\n        { id: 1, username: \"rowValue1\", email: \"email1@email.com\" },\n        { id: 2, username: \"rowValue2\", email: \"email2@email.com\" },\n        { id: 3, username: \"rowValue3\", email: \"email3@email.com\" },\n      ]);\n    });\n};\n```\n\nWe have our migrations and seeds set up now, let's run them and make sure everything is great. We can make our life a little easier by adding 2 more scripts to our package.json.\n\n```json\n{\n  \"scripts\": {\n    \"start\": \"node src/index.js\",\n    \"server\": \"nodemon src/index.js\",\n    \"db-remake\": \"psql -f remakeDatabase.sql\",\n    \"knex-refresh\": \"knex migrate:rollback && knex migrate:latest && knex seed:run\",\n    \"total-reset\": \"yarn db-remake && yarn knex-refresh\"\n  }\n}\n```\n\nYou probably we added `knex-refresh` and `total-reset`. Knex refresh command refreshes our migrations and runs our seeds in one command. If we make any changes to schema that breaks our postgres tables, we can just roll the whole thing back, database and all before we run our new migrations as seeds.\n\nOne **final** thing. We need to `touch src/data/knexConfig.js` and add the following code to it:\n\n```javascript\nconst knex = require(\"knex\");\nconst knexConfig = require(\"../../knexfile\");\n\nmodule.exports = knex(knexConfig.development);\n```\n\n### Step 4\n\nIn our package.json we have our main file set as `src/index.js`. Let's set that up. Run: `mkdir src && touch src/index.js`.\n\nBefore we set up our index.js, let's add a couple env variables we will need.\n\nCreate a .env file in the root of your project and add:\n\n```bash\nPORT = 4000\nDATABASE_URL = postgres://postgres:password@localhost:5432/my_db\n```\n\nNow that that we have those variables in place, let's write some code! ðŸ”¥\n\n```javascript\n// src/index.js\nconst { ApolloServer, gql } = require(\"apollo-server-express\");\nconst express = require(\"express\");\n\nconst db = require(\"./data/config\");\nconst app = express();\n\nrequire(\"dotenv\").config();\n\nconst port = process.env.PORT;\n\n// typeDefs is where we define what our schema looks like\nconst typeDefs = gql`\n  type User {\n    id: ID!\n    username: String!\n    email: String!\n    admin: Boolean!\n  }\n  type Query {\n    users: [User]!\n    user(id: ID!): User!\n  }\n`;\n\n// resolvers are where we put the logic to make our typeDefs come to life\nconst resolvers = {\n  Query: {\n    users(parent, args, ctx) {\n      return db(\"users\");\n    },\n    user(_, { id }) {\n      return db(\"users\").where({ id }).first();\n    },\n  },\n};\n\nconst server = new ApolloServer({\n  typeDefs,\n  resolvers,\n});\n\nserver.applyMiddleware({ app });\n\napp.listen(port, () =>\n  console.log(`ðŸ–¥ Server ready on http://localhost:${port}/grahql ðŸš€`)\n);\n```\n\nAnd that's it! We have a fully functional graphql server up in minutes! ðŸ”¥ Woo hoo!\n","data":{"title":"Knex - Graphql Back End","image":"https://i.imgur.com/yiDtHBp.png","description":"Firebase is an incredible platform to connect any iOS, android and/or web app too.  By connecting your project to Google's Firebase you will have access to their cloud storage, cloud firestore and real-time database, authentication, analytics and much more."}},"__N_SSG":true}